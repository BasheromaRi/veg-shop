<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ù…Ù„Ø§Øª ÙˆØ¹Ø±ÙˆØ¶</title>

  <link rel="stylesheet" href="/styles.css" />

  <style>
    .wrap{ margin-top:12px; }

    .card{
      background:#fff;
      border:1px solid #dfe7e2;
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 10px rgba(0,0,0,.06);
      margin-bottom:14px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:800px){
      .grid2{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-weight:900;
      font-size:13px;
      color:#1f3b2c;
      margin-bottom:6px;
    }
    input, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #d7e2db;
      border-radius:12px;
      font-size:14px;
      background:#fff;
      box-sizing:border-box;
      outline:none;
    }
    input:focus, textarea:focus{
      border-color:#9dd3b1;
      box-shadow:0 0 0 4px rgba(46,139,87,.10);
    }
    textarea{ min-height:90px; resize:vertical; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
    }
    .btn-green{ background:#2e8b57; color:#fff; }
    .btn-blue{ background:#2b74c7; color:#fff; }
    .btn-red{ background:#d83a3a; color:#fff; }
    .btn-light{ background:#eaf5ef; color:#0f2b1f; }

    .hint{
      color:#6a7b72;
      font-size:12px;
      line-height:1.5;
      margin-top:6px;
    }

    .list{
      display:grid;
      gap:12px;
    }

    .camp-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid transparent;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .b-on{ background:#eaf7ef; border-color:#a8e0be; color:#0f5a2a; }
    .b-off{ background:#ffecec; border-color:#ffc0c0; color:#8a1414; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:12px;
    }

    .split{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:10px;
      align-items:start;
    }
    @media (max-width:800px){
      .split{ grid-template-columns:1fr; }
    }

    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      margin-top:4px;
    }

    .empty{
      padding:14px;
      background:#fff;
      border:1px solid #dfe7e2;
      border-radius:14px;
      color:#6a7b72;
    }

    .err{
      padding:14px;
      background:#ffecec;
      border:1px solid #ffc0c0;
      border-radius:14px;
      color:#8a1414;
      font-weight:900;
      line-height:1.5;
    }

    .mini{
      font-size:12px;
      color:#6a7b72;
      font-weight:900;
      direction:ltr;
      text-align:left;
    }
  </style>
</head>

<body style="text-align:right;">
  <header>
    <span>Ø­Ù…Ù„Ø§Øª ÙˆØ¹Ø±ÙˆØ¶</span>
    <a href="/admin/secret-admin-9347" style="color:#fff; float:left; text-decoration:none; font-size:14px;">
      Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    </a>
  </header>

  <div class="container wrap">

    <div class="card">
      <h2 style="margin:0 0 10px; color:#2e8b57;">Ø¥Ø¶Ø§ÙØ© Ø­Ù…Ù„Ø© / Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h2>

      <form id="campaignForm">
        <div class="grid2">
          <div>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶</label>
            <input type="text" id="title" required placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10% Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" />
          </div>

          <div>
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
            <input type="number" id="discountPercent" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 10" />
          </div>

          <div style="grid-column:1/-1;">
            <label>ÙˆØµÙ / Ù†Øµ Ø§Ù„Ø¹Ø±Ø¶ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†)</label>
            <textarea id="description" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§..."></textarea>
          </div>

          <div>
            <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ (â‚ª)</label>
            <input type="number" id="minTotal" step="0.5" placeholder="Ù…Ø«Ø§Ù„: 200" />
          </div>

          <div>
            <label>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</label>
            <div class="switch">
              <input type="checkbox" id="active" checked />
              <span>Ø§Ù„Ø¹Ø±Ø¶ Ù†Ø´Ø· âœ…</span>
            </div>
            <div class="hint">Ø¥Ø°Ø§ Ø³ÙƒÙ‘Ø±Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ØŒ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø§ Ø±Ø­ ÙŠØ¨ÙŠÙ† Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†.</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-green" type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù…Ù„Ø© ğŸ¯</button>
          <button class="btn btn-light" type="button" onclick="formReset()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="row">
        <h2 style="margin:0; color:#2e8b57;">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
        <button class="btn btn-blue" type="button" onclick="loadCampaigns()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
      <div class="hint">Ø¨ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ø¨Ø³Ø±Ø¹Ø©: Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ø®ØµÙ…ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ØŒ ÙˆØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ø­Ø°Ù.</div>

      <div id="campaignsList" class="list" style="margin-top:12px;">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª...
      </div>
    </div>

  </div>

  <script>
    const form = document.getElementById('campaignForm');
    const campaignsListEl = document.getElementById('campaignsList');

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function formReset(){
      form.reset();
      document.getElementById('active').checked = true;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        discountPercent: document.getElementById('discountPercent').value || null,
        minTotal: document.getElementById('minTotal').value || null,
        active: document.getElementById('active').checked
      };

      try {
        const res = await fetch('/api/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.status === 401) { window.location.href = '/login.html'; return; }

        const data = await res.json().catch(()=>({}));

        if (!res.ok || !data.success) {
          alert(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù…Ù„Ø©');
          return;
        }

        alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ¯');
        formReset();
        loadCampaigns();
      } catch (err) {
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    });

    async function loadCampaigns() {
      campaignsListEl.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';

      try {
        const res = await fetch('/api/campaigns', { credentials:'include', cache:'no-store' });

        if (res.status === 401) { window.location.href = '/login.html'; return; }

        const data = await res.json().catch(()=>null);

        if (!res.ok) {
          campaignsListEl.innerHTML = `
            <div class="err">
              Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø§ Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br>
              ØºØ§Ù„Ø¨Ø§Ù‹ Route /api/campaigns Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ ÙÙŠ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ.
              <div class="mini">HTTP ${res.status}</div>
            </div>`;
          return;
        }

        if (!Array.isArray(data) || !data.length) {
          campaignsListEl.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
          return;
        }

        campaignsListEl.innerHTML = data.map(c => {
          const badge = c.active ? `<span class="badge b-on">Ù†Ø´Ø· âœ…</span>` : `<span class="badge b-off">ØºÙŠØ± Ù†Ø´Ø·</span>`;

          return `
            <div class="card">
              <div class="camp-head">
                <div style="font-weight:1000; color:#0f2b1f;">#${esc(c.id)} â€” ${badge}</div>
              </div>

              <div class="split">
                <div>
                  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                  <input id="title-${c.id}" type="text" value="${esc(c.title)}" />
                </div>

                <div>
                  <label>Ø§Ù„Ø®ØµÙ… (%)</label>
                  <input id="discountPercent-${c.id}" type="number" step="0.1" value="${c.discountPercent ?? ''}" placeholder="Ù…Ø«Ø§Ù„: 10" />
                </div>

                <div style="grid-column:1/-1;">
                  <label>Ø§Ù„ÙˆØµÙ</label>
                  <textarea id="description-${c.id}">${esc(c.description || '')}</textarea>
                </div>

                <div>
                  <label>Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨ (â‚ª)</label>
                  <input id="minTotal-${c.id}" type="number" step="0.5" value="${c.minTotal ?? ''}" placeholder="Ù…Ø«Ø§Ù„: 200" />
                </div>

                <div>
                  <label>ØªÙØ¹ÙŠÙ„</label>
                  <div class="switch">
                    <input id="active-${c.id}" type="checkbox" ${c.active ? 'checked' : ''} />
                    <span>${c.active ? 'Ù†Ø´Ø· âœ…' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span>
                  </div>
                </div>
              </div>

              <div class="actions">
                <button class="btn btn-blue" type="button" onclick="updateCampaign(${c.id})">ØªØ­Ø¯ÙŠØ« âœ…</button>
                <button class="btn btn-red" type="button" onclick="deleteCampaign(${c.id})">Ø­Ø°Ù âŒ</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error(err);
        campaignsListEl.innerHTML = `<div class="err">Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>`;
      }
    }

    async function updateCampaign(id) {
      const payload = {
        title: document.getElementById('title-' + id).value.trim(),
        description: document.getElementById('description-' + id).value.trim(),
        discountPercent: document.getElementById('discountPercent-' + id).value || null,
        minTotal: document.getElementById('minTotal-' + id).value || null,
        active: document.getElementById('active-' + id).checked
      };

      try {
        const res = await fetch('/api/campaigns/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (res.status === 401) { window.location.href = '/login.html'; return; }

        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.success) {
          alert(data.error || 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù…Ù„Ø©');
          return;
        }

        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù…Ù„Ø© âœ…');
        loadCampaigns();
      } catch (err) {
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    }

    async function deleteCampaign(id) {
      if (!confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©ØŸ')) return;

      try {
        const res = await fetch('/api/campaigns/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.status === 401) { window.location.href = '/login.html'; return; }

        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.success) {
          alert(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø©');
          return;
        }

        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø© âŒ');
        loadCampaigns();
      } catch (err) {
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    }

    document.addEventListener('DOMContentLoaded', loadCampaigns);
  </script>
</body>
</html>