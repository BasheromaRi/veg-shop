<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</title>

  <!-- ููู: absolute ุนุดุงู ูุดุชุบู ุณูุงุก ุงูููู ุฏุงุฎู /admin ุฃู /public -->
  <link rel="stylesheet" href="/styles.css">
</head>

<body style="text-align:right;">

<header>
  <span>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</span>
  <a href="/admin/secret-admin-9347" style="color:#fff; float:left;">ุฑุฌูุน</a>
</header>

<div class="container">
  <h2>ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</h2>

  <form id="productForm">
    <input id="name" placeholder="ุงุณู ุงูููุชุฌ" required><br><br>
    <input id="price" type="number" placeholder="ุงูุณุนุฑ" required><br><br>
    <input id="description" placeholder="ูุตู"><br><br>

    <select id="unitType">
      <option value="kg">ููููุบุฑุงู</option>
      <option value="bag">ููุณ</option>
    </select><br><br>

    <label>
      <input type="checkbox" id="available" checked>
      ูุชููุฑ
    </label><br><br>

    <button type="submit">โ ุฅุถุงูุฉ ุงูููุชุฌ</button>
    <p id="msg" style="margin-top:10px;color:red;"></p>
  </form>

  <hr>

  <h2>ุงูููุชุฌุงุช</h2>
  <div id="productsList">ุชุญููู...</div>
</div>

<script>
const msg = document.getElementById('msg');

function showError(text) {
  msg.textContent = text || '';
}

function esc(s) {
  return String(s ?? '').replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;');
}

function mustLogin() {
  alert('ุงูุชูุช ุงูุฌูุณุฉ. ุณุฌูู ุฏุฎูู ูู ุฌุฏูุฏ.');
  window.location.href = '/login.html';
}

async function loadProducts() {
  showError('');
  const div = document.getElementById('productsList');
  div.innerHTML = 'ุชุญููู...';

  try {
    const res = await fetch('/api/products', {
      method: 'GET',
      credentials: 'include'
    });

    const products = await res.json().catch(() => []);

    if (!res.ok) {
      div.innerHTML = '';
      if (res.status === 401) return mustLogin();
      showError(products?.error || 'ุฎุทุฃ ูู ุชุญููู ุงูููุชุฌุงุช');
      return;
    }

    div.innerHTML = '';
    if (!products.length) {
      div.innerHTML = 'ูุง ููุฌุฏ ููุชุฌุงุช ุจุนุฏ.';
      return;
    }

    products.forEach(p => {
      const id = p.id;
      div.innerHTML += `
        <div style="border:1px solid #ccc; padding:10px; margin-bottom:15px; border-radius:10px;">
          
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <b>#${id} - ${esc(p.name)}</b>

            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" onclick="enableEdit(${id})">โ๏ธ ุชุนุฏูู</button>
              <button type="button" onclick="saveEdit(${id})">๐พ ุญูุธ</button>
              <button type="button" onclick="deleteProduct(${id})"
                style="background:#c0392b;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">
                ๐๏ธ ุญุฐู
              </button>
            </div>
          </div>

          <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <label>ุงูุงุณู</label><br>
              <input id="p_name_${id}" value="${esc(p.name)}" disabled style="width:100%; padding:8px;">
            </div>

            <div>
              <label>ุงูุณุนุฑ</label><br>
              <input id="p_price_${id}" type="number" value="${esc(p.price)}" disabled style="width:100%; padding:8px;">
            </div>

            <div style="grid-column:1 / -1;">
              <label>ุงููุตู</label><br>
              <input id="p_desc_${id}" value="${esc(p.description)}" disabled style="width:100%; padding:8px;">
            </div>

            <div>
              <label>ุงููุญุฏุฉ</label><br>
              <select id="p_unit_${id}" disabled style="width:100%; padding:8px;">
                <option value="kg" ${p.unitType === 'kg' ? 'selected' : ''}>ููููุบุฑุงู</option>
                <option value="bag" ${p.unitType === 'bag' ? 'selected' : ''}>ููุณ</option>
              </select>
            </div>

            <div style="display:flex; align-items:end;">
              <label style="margin-bottom:6px;">
                <input id="p_av_${id}" type="checkbox" ${p.available ? 'checked' : ''} disabled>
                ูุชููุฑ
              </label>
            </div>
          </div>

          <hr style="margin:14px 0;">

          <label style="font-size:13px;">ุฑูุน ุตูุฑ ุงูููุชุฌ:</label><br>
          <input type="file" multiple accept="image/*"
            onchange="uploadImages(${id}, this.files)">
          <br><br>

          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            ${(p.images || []).map(img => `
              <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #ccc;border-radius:8px;">
            `).join('')}
          </div>

        </div>
      `;
    });

  } catch (err) {
    console.error(err);
    div.innerHTML = '';
    showError('ูุดููุฉ ุงุชุตุงู ุจุงูุณูุฑูุฑ');
  }
}

function enableEdit(id) {
  document.getElementById(`p_name_${id}`).disabled = false;
  document.getElementById(`p_price_${id}`).disabled = false;
  document.getElementById(`p_desc_${id}`).disabled = false;
  document.getElementById(`p_unit_${id}`).disabled = false;
  document.getElementById(`p_av_${id}`).disabled = false;
  alert('ุตุงุฑ ููู ุชุนุฏูู โ๏ธ ูุจุนุฏูุง ุงุถุบุท "ุญูุธ"');
}

async function saveEdit(id) {
  showError('');

  const body = {
    name: document.getElementById(`p_name_${id}`).value.trim(),
    price: Number(document.getElementById(`p_price_${id}`).value),
    description: document.getElementById(`p_desc_${id}`).value.trim(),
    unitType: document.getElementById(`p_unit_${id}`).value,
    available: document.getElementById(`p_av_${id}`).checked
  };

  try {
    const res = await fetch(`/api/products/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      if (res.status === 401) return mustLogin();
      alert(data?.error || 'ูุดู ุงูุญูุธ โ');
      return;
    }

    alert('ุชู ุงูุญูุธ โ');
    loadProducts();
  } catch (err) {
    console.error(err);
    alert('ูุดููุฉ ุงุชุตุงู ุจุงูุณูุฑูุฑ');
  }
}

async function deleteProduct(id) {
  showError('');
  if (!confirm('ูุชุฃูุฏ ุจุฏู ุชุญุฐู ุงูููุชุฌ ููุงุฆูุงูุ')) return;

  try {
    const res = await fetch(`/api/products/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      if (res.status === 401) return mustLogin();
      alert(data?.error || 'ูุดู ุงูุญุฐู โ');
      return;
    }

    alert('ุชู ุงูุญุฐู โ');
    loadProducts();
  } catch (err) {
    console.error(err);
    alert('ูุดููุฉ ุงุชุตุงู ุจุงูุณูุฑูุฑ');
  }
}

async function uploadImages(id, files) {
  showError('');
  if (!files || !files.length) return;

  const fd = new FormData();
  for (let f of files) fd.append('images', f);

  try {
    const res = await fetch(`/api/products/${id}/images`, {
      method: 'POST',
      credentials: 'include',
      body: fd
    });

    const data = await res.json().catch(() => ({}));

    if (res.ok) {
      alert('ุชู ุญูุธ ุงูุตูุฑ โ');
      loadProducts();
    } else {
      if (res.status === 401) return mustLogin();
      alert(data?.error || 'ุฎุทุฃ ูู ุฑูุน ุงูุตูุฑ โ');
    }
  } catch (err) {
    console.error(err);
    alert('ูุดููุฉ ุงุชุตุงู ุจุงูุณูุฑูุฑ');
  }
}

document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  showError('');

  const nameEl = document.getElementById('name');
  const priceEl = document.getElementById('price');
  const descEl = document.getElementById('description');
  const unitEl = document.getElementById('unitType');
  const availEl = document.getElementById('available');

  try {
    const res = await fetch('/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        name: nameEl.value.trim(),
        price: Number(priceEl.value),
        description: descEl.value.trim(),
        unitType: unitEl.value,
        available: !!availEl.checked
      })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      if (res.status === 401) return mustLogin();
      showError(data?.error || 'ูุดู ุฅุถุงูุฉ ุงูููุชุฌ');
      return;
    }

    e.target.reset();
    await loadProducts();
  } catch (err) {
    console.error(err);
    showError('ูุดููุฉ ุงุชุตุงู ุจุงูุณูุฑูุฑ');
  }
});

loadProducts();
</script>

</body>
</html>
