<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدارة المنتجات</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="text-align:right;">

<header>
  <span>إدارة المنتجات</span>
  <a href="admin.html" style="color:#fff; float:left;">رجوع</a>
</header>
 
<div class="container">
  <h2>إضافة منتج جديد</h2>

  <form id="productForm">
    <input id="name" placeholder="اسم المنتج" required><br><br>
    <input id="price" type="number" placeholder="السعر" required><br><br>
    <input id="description" placeholder="وصف"><br><br>

    <select id="unitType">
      <option value="kg">كيلوغرام</option>
      <option value="bag">كيس</option>
    </select><br><br>

    <label>
      <input type="checkbox" id="available" checked>
      متوفر
    </label><br><br>

    <button type="submit">➕ إضافة المنتج</button>
  </form>

  <hr>

  <h2>المنتجات</h2>
  <div id="productsList">تحميل...</div>
</div>

<script>
async function loadProducts() {
  const res = await fetch('/api/products');
  const products = await res.json();
  const div = document.getElementById('productsList');
  div.innerHTML = '';

  products.forEach(p => {
    div.innerHTML += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:15px;">
        <b>${p.name}</b> — ₪${p.price}<br><br>

        <label style="font-size:13px;">رفع صور المنتج:</label><br>
        <input type="file" multiple accept="image/*"
          onchange="uploadImages(${p.id}, this.files)">
        <br><br>

        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          ${(p.images || []).map(img =>
            `<img src="${img}"
              style="width:80px;height:80px;object-fit:cover;border:1px solid #ccc;">`
          ).join('')}
        </div>
      </div>
    `;
  });
}

async function uploadImages(id, files) {
  const fd = new FormData();
  for (let f of files) {
    fd.append('images', f);
  }

  const res = await fetch(`/api/products/${id}/images`, {
    method: 'POST',
    body: fd   // ❗ لا تضيف headers أبداً مع FormData
  });

  if (res.ok) {
    alert('تم حفظ الصور ✅');
    loadProducts();
  } else {
    alert('خطأ في رفع الصور ❌');
  }
}

document.getElementById('productForm').onsubmit = async e => {
  e.preventDefault();

  await fetch('/api/products', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name:name.value,
      price:price.value,
      description:description.value,
      unitType:unitType.value,
      available:available.checked
    })
  });

  e.target.reset();
  loadProducts();
};

loadProducts();
</script>

</body>
</html>
