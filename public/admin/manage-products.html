<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

  <link rel="stylesheet" href="/styles.css" />

  <style>
    body{ background:#f6f8f7; }

    .wrap{ margin-top:12px; }

    .panel{
      background:#fff;
      border:1px solid #e3ece6;
      border-radius:18px;
      padding:14px;
      box-shadow: 0 1px 12px rgba(0,0,0,.05);
      margin-bottom:12px;
    }

    .panel h2{
      margin:0 0 10px;
      font-size:16px;
      font-weight:1000;
      color:#0f2b1f;
    }

    .grid-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }

    .field label{
      display:block;
      font-size:12px;
      color:#6a7b72;
      font-weight:800;
      margin-bottom:6px;
    }

    .field input, .field select, .field textarea{
      width:100%;
      border:1px solid #d7e2db;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      outline:none;
    }

    .field textarea{
      min-height: 90px;
      resize: vertical;
    }

    .row-inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .check{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid #d7e2db;
      border-radius:12px;
      background:#fff;
      font-weight:900;
      font-size:13px;
      color:#0f2b1f;
      width:100%;
      justify-content:space-between;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:active{ transform:scale(.99); }

    .btn-green{ background:#2e8b57; color:#fff; }
    .btn-blue{ background:#2b74c7; color:#fff; }
    .btn-red{ background:#d83a3a; color:#fff; }
    .btn-light{ background:#eaf5ef; color:#0f2b1f; border:1px solid #cfe3d6; }

    .hint{
      margin-top:8px;
      color:#6a7b72;
      font-size:12px;
      font-weight:700;
      line-height:1.4;
    }

    .list{
      display:grid;
      gap:12px;
      margin-top:12px;
    }

    .card{
      background:#fff;
      border:1px solid #e3ece6;
      border-radius:18px;
      padding:12px;
      box-shadow: 0 1px 12px rgba(0,0,0,.05);
    }

    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .title{
      font-weight:1000;
      color:#0f2b1f;
      font-size:15px;
    }

    .sub{
      margin-top:4px;
      color:#6a7b72;
      font-size:12px;
      font-weight:700;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .b-on{ background:#eaf7ef; border-color:#a8e0be; color:#0f5a2a; }
    .b-off{ background:#ffecec; border-color:#ffc0c0; color:#8a1414; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:10px;
    }

    .edit-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .images{
      margin-top:10px;
      border-top:1px dashed #d7e2db;
      padding-top:10px;
      display:grid;
      gap:10px;
    }

    .thumbs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .thumb{
      width:74px;
      height:74px;
      border-radius:12px;
      border:1px solid #d7e2db;
      object-fit:cover;
      background:#fff;
    }

    .upload-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .file{
      border:1px solid #d7e2db;
      border-radius:12px;
      padding:10px;
      background:#fff;
      width:100%;
    }

    .msg{
      margin-top:8px;
      font-size:12px;
      font-weight:800;
      color:#d83a3a;
    }

    @media (max-width: 720px){
      .grid-form{ grid-template-columns:1fr; }
      .edit-grid{ grid-template-columns:1fr; }
      .btn{ width:100%; }
      .actions{ justify-content:stretch; }
    }
  </style>
</head>

<body style="text-align:right;">
  <header>
    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
    <a href="/admin/secret-admin-9347" style="color:#fff; float:left; text-decoration:none; font-size:14px;">
      Ø±Ø¬ÙˆØ¹
    </a>
  </header>

  <div class="container wrap">
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
    <div class="panel">
      <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>

      <form id="addForm">
        <div class="grid-form">
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input id="add_name" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„ÙˆØ®ÙŠØ© Ù…Ù‚Ø·Ù‘ÙØ©" />
          </div>

          <div class="field">
            <label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label>
            <input id="add_price" type="number" required step="0.5" placeholder="Ù…Ø«Ø§Ù„: 25" />
          </div>

          <div class="field">
            <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="add_unitType">
              <option value="kg">ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…</option>
              <option value="bag">ÙƒÙŠØ³</option>
            </select>
          </div>

          <div class="field">
            <label>Ø§Ù„ØªÙˆÙØ±</label>
            <div class="check">
              <span>Ù…ØªÙˆÙØ±</span>
              <input id="add_available" type="checkbox" checked />
            </div>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="add_description" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ± Ù„Ù„Ù…Ù†ØªØ¬..."></textarea>
          </div>

          <div style="grid-column: 1 / -1;">
            <button class="btn btn-green" type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
            <div class="hint">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„/ØªØ­Ø°Ù ÙˆØªØ±ÙØ¹ ØµÙˆØ± Ù„Ù„Ù…Ù†ØªØ¬.</div>
            <div id="addMsg" class="msg"></div>
          </div>
        </div>
      </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="panel">
      <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div id="list" class="list">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const addMsg = document.getElementById('addMsg');

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    async function api(url, opts={}){
      const res = await fetch(url, { credentials:'include', ...opts });
      const data = await res.json().catch(()=> ({}));
      return { res, data };
    }

    async function loadProducts(){
      listEl.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';

      const { res, data } = await api('/api/products', { method:'GET' });
      if (!res.ok){
        if (res.status === 401){
          window.location.href = '/login.html';
          return;
        }
        listEl.innerHTML = `<div class="hint">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>`;
        return;
      }

      const products = Array.isArray(data) ? data : [];
      if (!products.length){
        listEl.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</div>`;
        return;
      }

      listEl.innerHTML = products.map(p => {
        const available = !!p.available;
        const badge = available
          ? `<span class="badge b-on">Ù…ØªÙˆÙØ±</span>`
          : `<span class="badge b-off">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>`;

        const unitLabel = p.unitType === 'bag' ? 'ÙƒÙŠØ³' : 'ÙƒØºÙ…';
        const imgs = (p.images || []).map(src => `<img class="thumb" src="${esc(src)}" />`).join('');

        return `
          <div class="card" id="p_${esc(p.id)}">
            <div class="card-head">
              <div>
                <div class="title">#${esc(p.id)} â€” ${esc(p.name)}</div>
                <div class="sub">â‚ª${esc(p.price)} Ù„ÙƒÙ„ ${unitLabel}</div>
              </div>
              ${badge}
            </div>

            <div class="edit-grid">
              <div class="field">
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input id="name_${esc(p.id)}" value="${esc(p.name)}" disabled />
              </div>

              <div class="field">
                <label>Ø§Ù„Ø³Ø¹Ø± (â‚ª)</label>
                <input id="price_${esc(p.id)}" type="number" step="0.5" value="${esc(p.price)}" disabled />
              </div>

              <div class="field">
                <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                <select id="unit_${esc(p.id)}" disabled>
                  <option value="kg" ${p.unitType==='kg'?'selected':''}>ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…</option>
                  <option value="bag" ${p.unitType==='bag'?'selected':''}>ÙƒÙŠØ³</option>
                </select>
              </div>

              <div class="field">
                <label>Ø§Ù„ØªÙˆÙØ±</label>
                <div class="check">
                  <span>${available ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                  <input id="avail_${esc(p.id)}" type="checkbox" ${available?'checked':''} disabled />
                </div>
              </div>

              <div class="field" style="grid-column: 1 / -1;">
                <label>Ø§Ù„ÙˆØµÙ</label>
                <textarea id="desc_${esc(p.id)}" disabled>${esc(p.description||'')}</textarea>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-blue" type="button" onclick="enableEdit(${esc(p.id)})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-green" type="button" onclick="saveProduct(${esc(p.id)})">ğŸ’¾ Ø­ÙØ¸</button>
              <button class="btn btn-red" type="button" onclick="deleteProduct(${esc(p.id)})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>

            <div class="images">
              <div class="upload-row">
                <div style="font-weight:1000; color:#0f2b1f;">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</div>
              </div>

              <div class="thumbs">
                ${imgs || `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯.</div>`}
              </div>

              <div class="upload-row">
                <input class="file" type="file" accept="image/*" multiple
                  onchange="uploadImages(${esc(p.id)}, this.files)" />
              </div>
            </div>

            <div id="msg_${esc(p.id)}" class="msg"></div>
          </div>
        `;
      }).join('');
    }

    window.enableEdit = function(id){
      document.getElementById(`name_${id}`).disabled = false;
      document.getElementById(`price_${id}`).disabled = false;
      document.getElementById(`unit_${id}`).disabled = false;
      document.getElementById(`avail_${id}`).disabled = false;
      document.getElementById(`desc_${id}`).disabled = false;

      const m = document.getElementById(`msg_${id}`);
      m.style.color = '#2b74c7';
      m.textContent = 'Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØªÙˆØ­â€¦ Ø¹Ø¯Ù‘Ù„ ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø¶ØºØ· Ø­ÙØ¸ âœ…';
    }

    window.saveProduct = async function(id){
      const m = document.getElementById(`msg_${id}`);
      m.style.color = '#d83a3a';
      m.textContent = '';

      const payload = {
        name: document.getElementById(`name_${id}`).value.trim(),
        price: Number(document.getElementById(`price_${id}`).value),
        unitType: document.getElementById(`unit_${id}`).value,
        available: !!document.getElementById(`avail_${id}`).checked,
        description: document.getElementById(`desc_${id}`).value.trim()
      };

      const { res, data } = await api(`/api/products/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        if (res.status === 401){ window.location.href='/login.html'; return; }
        m.textContent = data?.error || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        return;
      }

      m.style.color = '#2e8b57';
      m.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…';

      // Ø³ÙƒÙ‘Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      document.getElementById(`name_${id}`).disabled = true;
      document.getElementById(`price_${id}`).disabled = true;
      document.getElementById(`unit_${id}`).disabled = true;
      document.getElementById(`avail_${id}`).disabled = true;
      document.getElementById(`desc_${id}`).disabled = true;

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¨Ø§Ø¯Ø¬/Ø§Ù„Ø¹Ø±Ø¶ ÙŠØªØ­Ø¯Ù‘Ø«ÙˆØ§
      loadProducts();
    }

    window.deleteProduct = async function(id){
      if (!confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;

      const { res, data } = await api(`/api/products/${id}`, { method:'DELETE' });
      if (!res.ok){
        if (res.status === 401){ window.location.href='/login.html'; return; }
        alert(data?.error || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬');
        return;
      }
      loadProducts();
    }

    window.uploadImages = async function(id, files){
      if (!files || !files.length) return;

      const fd = new FormData();
      for (const f of files) fd.append('images', f);

      const { res, data } = await api(`/api/products/${id}/images`, {
        method:'POST',
        body: fd
      });

      if (!res.ok){
        if (res.status === 401){ window.location.href='/login.html'; return; }
        alert(data?.error || 'Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±');
        return;
      }

      alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± âœ…');
      loadProducts();
    }

    document.getElementById('addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      addMsg.textContent = '';
      addMsg.style.color = '#d83a3a';

      const payload = {
        name: document.getElementById('add_name').value.trim(),
        price: Number(document.getElementById('add_price').value),
        description: document.getElementById('add_description').value.trim(),
        unitType: document.getElementById('add_unitType').value,
        available: !!document.getElementById('add_available').checked
      };

      const { res, data } = await api('/api/products', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        if (res.status === 401){ window.location.href='/login.html'; return; }
        addMsg.textContent = data?.error || 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬';
        return;
      }

      addMsg.style.color = '#2e8b57';
      addMsg.textContent = 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…';

      e.target.reset();
      document.getElementById('add_available').checked = true;
      document.getElementById('add_unitType').value = 'kg';

      loadProducts();
      setTimeout(()=> addMsg.textContent='', 2500);
    });

    loadProducts();
  </script>
</body>
</html>
