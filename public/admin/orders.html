<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</title>

  <link rel="stylesheet" href="/styles.css" />

  <style>
    .wrap { margin-top: 12px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap; margin: 10px 0 14px;
    }
    .filters{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pill{
      border:1px solid #d7e2db; background:#fff; padding:8px 10px;
      border-radius:999px; cursor:pointer; font-weight:900; font-size:13px;
    }
    .pill.active{ background:#eaf5ef; border-color:#9dd3b1; }

    .search{ flex:1; min-width: 220px; display:flex; gap:8px; align-items:center; }
    .search input{
      width:100%; padding:10px 12px; border:1px solid #d7e2db;
      border-radius:12px; font-size:14px;
    }
    .hint{ color:#6a7b72; font-size:12px; margin-top:6px; line-height:1.4; }

    .grid{ display:grid; gap:12px; margin: 12px 0 18px; }
    .card{
      background:#fff; border:1px solid #dfe7e2; border-radius:16px;
      padding:12px; box-shadow: 0 1px 10px rgba(0,0,0,.06);
    }
    .card-head{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap; margin-bottom:10px;
    }
    .order-title{ font-weight:1000; color:#0f2b1f; font-size:16px; }
    .meta{ color:#6a7b72; font-size:12px; margin-top:4px; }

    .badge{
      padding:6px 10px; border-radius:999px; font-weight:900;
      font-size:12px; border:1px solid transparent; white-space:nowrap;
      display:inline-flex; align-items:center; gap:6px;
    }
    .b-new{ background:#fff7e6; border-color:#ffd38a; color:#7a4b00; }
    .b-progress{ background:#e9f3ff; border-color:#b7d8ff; color:#084b8a; }
    .b-done{ background:#eaf7ef; border-color:#a8e0be; color:#0f5a2a; }
    .b-cancel{ background:#ffecec; border-color:#ffc0c0; color:#8a1414; }
    .b-contact{ background:#f1ecff; border-color:#d2c0ff; color:#4b2b8a; }

    /* âœ… Ø¨Ø§Ø¯Ø¬ Ù„Ù„Ø´Ù„ÙŠØ­ */
    .b-courier{ background:#eef6ff; border-color:#b9d7ff; color:#0b3c75; }

    .rows{ display:grid; gap:8px; margin: 8px 0 12px; }
    .row{
      display:flex; justify-content:space-between; gap:10px;
      flex-wrap:wrap; font-size:14px;
    }
    .label{ color:#6a7b72; font-size:12px; }
    .value{ font-weight:900; text-align:left; direction:ltr; }
    .addr{ direction:rtl; text-align:right; font-weight:800; }

    .items{ margin-top:10px; border-top:1px dashed #d7e2db; padding-top:10px; }
    .item{
      display:flex; justify-content:space-between; gap:10px;
      padding:8px 0; border-bottom:1px solid #f0f3f1; font-size:14px;
    }
    .item:last-child{ border-bottom:none; }
    .item strong{ font-weight:1000; }
    .muted{ color:#6a7b72; font-size:12px; }

    .summary{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background:#f6fbf8;
      border:1px solid #cfe3d6;
      display:grid;
      gap:8px;
      font-weight:1000;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .sum-row small{
      font-weight:900;
      color:#6a7b72;
    }

    /* âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ */
    .cancel-box{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background:#ffecec;
      border:1px solid #ffc0c0;
      color:#8a1414;
      font-weight:900;
      line-height:1.6;
    }
    .cancel-box small{
      display:block;
      color:#8a1414;
      opacity:.85;
      margin-bottom:4px;
      font-weight:1000;
    }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      margin-top:12px;
    }
    .btn{
      border:none; border-radius:12px; padding:10px 12px;
      cursor:pointer; font-weight:1000; font-size:13px;
    }
    .btn:active{ transform: scale(.99); }
    .btn-green{ background:#2e8b57; color:#fff; }
    .btn-blue{ background:#2b74c7; color:#fff; }
    .btn-red{ background:#d83a3a; color:#fff; }
    .btn-light{ background:#eaf5ef; color:#0f2b1f; }

    /* âœ… Ø²Ø± Ù„Ù„Ø´Ù„ÙŠØ­ */
    .btn-courier{ background:#0b5bd3; color:#fff; }
    .btn-courier-off{ background:#e9f2ff; color:#0b3c75; border:1px solid #b9d7ff; }

    .status-line{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:space-between; margin-top:12px;
    }
    select{
      padding:10px 12px; border:1px solid #d7e2db;
      border-radius:12px; font-weight:900; background:#fff;
      min-width: 180px;
    }

    .empty{
      padding:14px; background:#fff; border:1px solid #dfe7e2;
      border-radius:14px; color:#6a7b72;
    }

    @media (max-width:700px){
      .actions{ justify-content:stretch; }
      .btn{ width:100%; }
      select{ width:100%; }
    }
  </style>
</head>

<body style="text-align:right;">
  <header>
    <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
    <a href="/admin/secret-admin-9347" style="color:#fff; float:left; text-decoration:none; font-size:14px;">
      Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©
    </a>
  </header>

  <div class="container wrap">
    <div class="topbar">
      <div class="filters">
        <button class="pill active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
        <button class="pill" data-filter="courier">Ù„Ù„Ø´Ù„ÙŠØ­</button>
        <button class="pill" data-filter="new">Ø¬Ø¯ÙŠØ¯</button>
        <button class="pill" data-filter="contacted">ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„</button>
        <button class="pill" data-filter="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
        <button class="pill" data-filter="done">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>
        <button class="pill" data-filter="cancelled">Ù…Ù„ØºÙŠ</button>
      </div>

      <div class="search">
        <input id="q" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø¨Ù„Ø¯..." />
      </div>
    </div>

    <div class="hint">
      Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ ÙÙˆÙ‚ 300â‚ª â€” ÙˆØªØ­Øª 300â‚ª Ø§Ù„ØªÙˆØµÙŠÙ„ 30â‚ª.
      âœ… â€œÙ„Ù„Ø´Ù„ÙŠØ­â€ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ù„Ù„Ø´Ù„ÙŠØ­ ÙÙ‚Ø·.
    </div>

    <div id="list" class="grid">ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <script>
    const list = document.getElementById('list');
    const q = document.getElementById('q');

    let orders = [];
    let currentFilter = 'all';

    // âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„
    const FREE_DELIVERY_FROM = 300;
    const DELIVERY_FEE = 30;

    // âœ… Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø¯ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ©
    const DEFAULT_COUNTRY_CODE = '972';

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function formatDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString('ar-EG', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit'
        });
      }catch(e){ return iso || ''; }
    }

    function statusBadge(status){
      const s = status || 'new';
      if (s === 'done') return `<span class="badge b-done">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span>`;
      if (s === 'in_progress') return `<span class="badge b-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>`;
      if (s === 'contacted') return `<span class="badge b-contact">ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„</span>`;
      if (s === 'cancelled') return `<span class="badge b-cancel">Ù…Ù„ØºÙŠ</span>`;
      return `<span class="badge b-new">Ø¬Ø¯ÙŠØ¯</span>`;
    }

    function courierBadge(assigned){
      return assigned ? `<span class="badge b-courier">Ù„Ù„Ø´Ù„ÙŠØ­ âœ…</span>` : '';
    }

    function calcSubtotal(items){
      return (items || []).reduce((sum, i) => sum + (Number(i.price)||0) * (Number(i.qty)||0), 0);
    }

    function calcDelivery(subtotal){
      return subtotal >= FREE_DELIVERY_FROM ? 0 : DELIVERY_FEE;
    }

    function calcGrandTotal(items){
      const subtotal = calcSubtotal(items);
      const delivery = calcDelivery(subtotal);
      return { subtotal, delivery, total: subtotal + delivery };
    }

    function normalizeOrder(o){
      let items = o.items;
      if (typeof items === 'string'){
        try{ items = JSON.parse(items); } catch(e){ items = []; }
      }
      return {
        ...o,
        items: Array.isArray(items) ? items : [],
        assignedToCourier: Number(o.assignedToCourier || 0),
        cancelReason: o.cancelReason || ''   // âœ… Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
      };
    }

    function normalizePhoneToE164(phone){
      let digits = String(phone || '').replace(/\D/g,'');
      if (!digits) return '';
      if (digits.startsWith('00')) digits = digits.slice(2);
      if (digits.startsWith(DEFAULT_COUNTRY_CODE)) return digits;
      if (digits.startsWith('0')) return DEFAULT_COUNTRY_CODE + digits.slice(1);
      if (digits.length >= 8 && digits.length <= 10) return DEFAULT_COUNTRY_CODE + digits;
      return digits;
    }

    function buildWhatsappText(order){
      const items = (order.items || []).map(i =>
        `- ${i.name} â€” ${i.qty} ${i.unitType === 'bag' ? 'ÙƒÙŠØ³' : 'ÙƒØºÙ…'} â€” â‚ª${(Number(i.price)||0) * (Number(i.qty)||0)}`
      ).join('\n');

      const { subtotal, delivery, total } = calcGrandTotal(order.items || []);
      const deliveryText = delivery === 0 ? 'ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ âœ…' : `â‚ª${delivery}`;

      return `Ù…Ø±Ø­Ø¨Ø§ ${order.name || ''} ğŸ‘‹
ØªÙ… ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…
ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (#${order.id}):

${items || '- (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª)'}

Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„: â‚ª${subtotal}
ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${deliveryText}
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙØ¹: â‚ª${total}

ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ××™×§×•× (Location) Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ âœ…`;
    }

    function makeWhatsAppLink(phoneE164, text){
      const msg = encodeURIComponent(text || '');
      return `https://wa.me/${phoneE164}?text=${msg}`;
    }

    async function fetchOrders(){
      list.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';
      try{
        const res = await fetch('/api/orders', { credentials:'include' });
        if (!res.ok){
          if (res.status === 401){
            window.location.href = '/login.html';
            return;
          }
          list.innerHTML = `<div class="empty">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</div>`;
          return;
        }
        const data = await res.json();
        orders = (data || []).map(normalizeOrder);
        render();
      }catch(err){
        console.error(err);
        list.innerHTML = `<div class="empty">Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>`;
      }
    }

    function matchesSearch(order, text){
      if (!text) return true;
      const t = text.toLowerCase();
      const hay = `${order.name||''} ${order.phone||''} ${order.country||''} ${order.address||''}`.toLowerCase();
      return hay.includes(t);
    }

    function matchesFilter(order){
      if (currentFilter === 'all') return true;
      if (currentFilter === 'courier') return Number(order.assignedToCourier || 0) === 1;
      return (order.status || 'new') === currentFilter;
    }

    function render(){
      const text = q.value.trim();
      const filtered = orders
        .filter(o => matchesFilter(o))
        .filter(o => matchesSearch(o, text))
        .sort((a,b) => (b.id||0) - (a.id||0));

      if (!filtered.length){
        list.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙÙ„ØªØ±Ø©.</div>`;
        return;
      }

      list.innerHTML = filtered.map(o => {
        const { subtotal, delivery, total } = calcGrandTotal(o.items || []);
        const phoneE164 = normalizePhoneToE164(o.phone || '');
        const waLink = phoneE164 ? makeWhatsAppLink(phoneE164, buildWhatsappText(o)) : null;

        const itemsHtml = (o.items || []).map(it => {
          const unit = it.unitType === 'bag' ? 'ÙƒÙŠØ³' : 'ÙƒØºÙ…';
          const line = (Number(it.price)||0) * (Number(it.qty)||0);
          return `
            <div class="item">
              <div>
                <strong>${esc(it.name)}</strong>
                <div class="muted">${esc(it.qty)} ${unit} Ã— â‚ª${esc(it.price)}</div>
              </div>
              <div style="font-weight:1000;">â‚ª${esc(line)}</div>
            </div>
          `;
        }).join('');

        const isAssigned = Number(o.assignedToCourier || 0) === 1;

        const cancelHtml = (o.status === 'cancelled' && (o.cancelReason || '').trim())
          ? `<div class="cancel-box">
               <small>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</small>
               ${esc(o.cancelReason)}
             </div>`
          : '';

        return `
          <div class="card">
            <div class="card-head">
              <div>
                <div class="order-title">Ø·Ù„Ø¨ Ø±Ù‚Ù… #${esc(o.id)}</div>
                <div class="meta">${formatDate(o.createdAt)}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                ${courierBadge(isAssigned)}
                ${statusBadge(o.status)}
              </div>
            </div>

            <div class="rows">
              <div class="row">
                <div class="label">Ø§Ù„Ø§Ø³Ù…</div>
                <div class="value" style="direction:rtl; text-align:right; font-weight:1000;">${esc(o.name)}</div>
              </div>
              <div class="row">
                <div class="label">Ø§Ù„Ù‡Ø§ØªÙ</div>
                <div class="value">${esc(o.phone)}</div>
              </div>
              <div class="row">
                <div class="label">Ø§Ù„Ø¨Ù„Ø¯</div>
                <div class="value" style="direction:rtl; text-align:right;">${esc(o.country)}</div>
              </div>
              <div class="row">
                <div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
                <div class="addr">${esc(o.address)}</div>
              </div>
            </div>

            ${cancelHtml}

            <div class="items">
              <div style="font-weight:1000; margin-bottom:8px;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
              ${itemsHtml || '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>'}
            </div>

            <div class="summary">
              <div class="sum-row"><small>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</small><div>â‚ª${esc(subtotal)}</div></div>
              <div class="sum-row"><small>Ø§Ù„ØªÙˆØµÙŠÙ„</small><div>${delivery === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ âœ…' : 'â‚ª' + esc(delivery)}</div></div>
              <div class="sum-row" style="border-top:1px dashed #cfe3d6; padding-top:8px;">
                <small>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</small><div>â‚ª${esc(total)}</div>
              </div>
            </div>

            <div class="status-line">
              <div style="font-weight:1000;">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</div>
              <select onchange="updateStatus(${esc(o.id)}, this.value)">
                <option value="new" ${(o.status||'new')==='new' ? 'selected':''}>Ø¬Ø¯ÙŠØ¯</option>
                <option value="contacted" ${(o.status||'new')==='contacted' ? 'selected':''}>ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„</option>
                <option value="in_progress" ${(o.status||'new')==='in_progress' ? 'selected':''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</option>
                <option value="done" ${(o.status||'new')==='done' ? 'selected':''}>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="cancelled" ${(o.status||'new')==='cancelled' ? 'selected':''}>Ù…Ù„ØºÙŠ</option>
              </select>
            </div>

            <div class="actions">
              ${
                waLink
                ? `<a class="btn btn-green" style="text-decoration:none; display:inline-block;" rel="noopener" target="_blank" href="${waLink}">ÙˆØ§ØªØ³Ø§Ø¨</a>
                   <button class="btn btn-blue" type="button" onclick="contactAndOpen(${esc(o.id)}, '${waLink.replace(/'/g,"\\'")}')">ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ + ÙˆØ§ØªØ³Ø§Ø¨</button>`
                : `<button class="btn btn-light" type="button" disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</button>`
              }

              <button
                class="btn ${isAssigned ? 'btn-courier-off' : 'btn-courier'}"
                type="button"
                onclick="toggleCourier(${esc(o.id)}, ${isAssigned ? 'true' : 'false'})">
                ${isAssigned ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ù„ÙŠØ­' : 'Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø´Ù„ÙŠØ­'}
              </button>

              <button class="btn btn-red" type="button" onclick="deleteOrder(${esc(o.id)})">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
          </div>
        `;
      }).join('');
    }

    document.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        render();
      });
    });

    q.addEventListener('input', () => render());

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© + Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    window.updateStatus = async function(id, status){
      const prev = orders.find(o => o.id == id);
      const oldStatus = prev ? (prev.status || 'new') : 'new';

      let cancelReason = '';

      if (status === 'cancelled'){
        cancelReason = prompt('Ù„ÙŠØ´ Ø§Ù†Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:') || '';
        cancelReason = cancelReason.trim();

        if (!cancelReason){
          alert('Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
          // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨ØµØ±ÙŠØ§Ù‹
          render();
          return;
        }
      }

      try{
        const res = await fetch(`/api/orders/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          credentials:'include',
          body: JSON.stringify({
            status,
            cancelReason: status === 'cancelled' ? cancelReason : '' // âœ…
          })
        });

        if (!res.ok){
          if (res.status === 401){ window.location.href = '/login.html'; return; }
          alert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©');
          // Ø±Ø¬Ù‘Ø¹ Ø¨ØµØ±ÙŠØ§Ù‹
          if (prev) prev.status = oldStatus;
          render();
          return;
        }

        const idx = orders.findIndex(o => o.id == id);
        if (idx >= 0){
          orders[idx].status = status;
          orders[idx].cancelReason = (status === 'cancelled') ? cancelReason : '';
        }
        render();
      }catch(err){
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
        if (prev) prev.status = oldStatus;
        render();
      }
    };

    window.contactAndOpen = async function(id, waLink){
      await window.updateStatus(id, 'contacted');
      window.location.href = waLink;
    };

    // âœ… Ø¥Ø±Ø³Ø§Ù„/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ù„ÙŠØ­
    window.toggleCourier = async function(id, isAssignedNow){
      const newVal = !isAssignedNow;
      try{
        const res = await fetch(`/api/orders/${id}/assign`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ assigned: newVal })
        });

        const data = await res.json().catch(()=>({}));

        if (!res.ok){
          if (res.status === 401){ window.location.href = '/login.html'; return; }
          alert(data?.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø´Ù„ÙŠØ­');
          return;
        }

        const idx = orders.findIndex(o => o.id == id);
        if (idx >= 0) orders[idx].assignedToCourier = newVal ? 1 : 0;
        render();
      }catch(err){
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    };

    window.deleteOrder = async function(id){
      if (!confirm('Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;

      try{
        const res = await fetch(`/api/orders/${id}`, {
          method:'DELETE',
          credentials:'include'
        });

        if (!res.ok){
          if (res.status === 401){ window.location.href = '/login.html'; return; }
          alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨');
          return;
        }

        orders = orders.filter(o => o.id != id);
        render();
      }catch(err){
        console.error(err);
        alert('Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    };

    fetchOrders();
  </script>
</body>
</html>
