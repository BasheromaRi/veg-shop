<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
  <a href="admin.html" style="color:#fff; float:left; text-decoration:none; font-size:14px;">
    Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
  </a>
</header>

<div class="container">
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
  <p style="color:#555; margin-bottom:10px;">
    Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø­Ø§Ù„ØªÙ‡Ø§ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨.
  </p>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© -->
  <div class="orders-filters" style="margin-bottom:15px;">
    <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn" data-filter="new">Ø¬Ø¯ÙŠØ¯</button>
    <button class="filter-btn" data-filter="contacted">ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„</button>
    <button class="filter-btn" data-filter="done">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
  </div>

  <div id="ordersContainer">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
</div>

<script>
  let currentFilter = 'all';
  window.allOrders = [];

  function formatDate(iso) {
    if (!iso) return '';
    try {
      return new Date(iso).toLocaleString('he-IL');
    } catch {
      return iso;
    }
  }

  function renderOrders(orders) {
    const container = document.getElementById('ordersContainer');

    if (!orders.length) {
      container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
      return;
    }

    container.innerHTML = '';

    const statusLabel = {
      new: 'Ø¬Ø¯ÙŠØ¯',
      contacted: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„',
      done: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
    };

    const statusColor = {
      new: '#e67e22',
      contacted: '#2980b9',
      done: '#27ae60'
    };

    orders.forEach(order => {
      let totalPrice = 0;

      (order.items || []).forEach(item => {
        if (!item || item.price == null || item.qty == null) return;
        totalPrice += Number(item.price) * Number(item.qty);
      });


      const itemsHtml = (order.items || [])
        .filter(item => item && item.price != null && item.qty != null)
        .map(item => {
          const line = Number(item.price) * Number(item.qty);
          return `<div>- ${item.name} â€” ${item.qty} ÙƒØºÙ… â€” ${line} â‚ª</div>`;
        }).join('');


      const currentStatus = order.status || 'new';

      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
          <strong>Ø·Ù„Ø¨ Ø±Ù‚Ù… #${order.id}</strong>
          <span style="
            background:${statusColor[currentStatus]};
            color:white;
            padding:3px 8px;
            border-radius:12px;
            font-size:12px;
          ">
            ${statusLabel[currentStatus]}
          </span>
        </div>

        <div style="font-size:13px; color:#555;">${formatDate(order.createdAt)}</div>

        <div style="margin-top:6px;">
          <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${order.name}</div>
          <div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.phone}</div>
          <div><strong>Ø§Ù„Ø¨Ù„Ø¯:</strong> ${order.country}</div>
          <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.address}</div>
        </div>

        <div style="margin-top:8px;">
          <strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong>
          ${itemsHtml}
        </div>

        <div style="margin-top:6px; font-weight:bold;">
          Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalPrice} â‚ª
        </div>

        <div style="margin-top:8px;">
          <label>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</label>
          <select onchange="event.stopPropagation(); changeOrderStatus(${order.id}, this.value)">
            <option value="new" ${currentStatus==='new'?'selected':''}>Ø¬Ø¯ÙŠØ¯</option>
            <option value="contacted" ${currentStatus==='contacted'?'selected':''}>ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„</option>
            <option value="done" ${currentStatus==='done'?'selected':''}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
          </select>
        </div>

        <div style="margin-top:10px;">
          <button onclick="sendWhatsApp(event, ${order.id})"
            style="background:#25D366; color:white; padding:8px 12px; border:none; border-radius:6px; font-weight:bold;">
            ÙˆØ§ØªØ³Ø§Ø¨
          </button>

          <button onclick="deleteOrder(${order.id})"
            style="background:#d9534f; color:white; padding:6px 10px; border:none; border-radius:6px; font-weight:bold;">
            Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
          </button>
        </div>
      `;

      container.appendChild(card);
    });
  }

  function applyFilterAndRender() {
    let filtered = window.allOrders;
    if (currentFilter !== 'all') {
      filtered = window.allOrders.filter(o => (o.status || 'new') === currentFilter);
    }
    renderOrders(filtered);
  }

  async function loadOrders() {
    const res = await fetch('/api/orders');
    const data = await res.json();
    window.allOrders = data;
    applyFilterAndRender();
  }

  async function changeOrderStatus(id, newStatus) {
    const res = await fetch('/api/orders/' + id + '/status', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });

    const data = await res.json();
    if (!res.ok || !data.success) {
      alert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©');
      return;
    }

    const order = window.allOrders.find(o => o.id === id);
    if (order) order.status = newStatus;

    applyFilterAndRender();
  }

  async function sendWhatsApp(e, orderId) {
    e.preventDefault();
    e.stopPropagation();

    await changeOrderStatus(orderId, 'contacted');

    const order = window.allOrders.find(o => o.id === orderId);
    if (!order) return;

    let msg = `Ù…Ø±Ø­Ø¨Ø§ ${order.name}\n`;
      msg += `ØªÙ… ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.\n`;
      msg += `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:\n`;

      let total = 0;

      (order.items || []).forEach(item => {
        if (!item || item.price == null || item.qty == null) return;

        const line = Number(item.price) * Number(item.qty);
        total += line;

        msg += `- ${item.name}: ${item.qty} ÙƒØºÙ… â€” ${line} Ø´Ø§Ù‚Ù„\n`;
      });

      // ğŸ”¹ Ø§Ù„ØªÙˆØµÙŠÙ„
      const deliveryCost = total >= 300 ? 0 : 30;
      const finalTotal = total + deliveryCost;

      msg += `\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„: ${total} Ø´Ø§Ù‚Ù„\n`;
      msg += `ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${deliveryCost} Ø´Ø§Ù‚Ù„\n`;
      msg += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙØ¹: ${finalTotal} Ø´Ø§Ù‚Ù„\n\n`;

      msg += `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø¨Ù„ ÙŠÙˆÙ… Ù…Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„.\n`;
      msg += `ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨.`;


    let phone = order.phone;
    if (!phone.startsWith('972')) {
      phone = '972' + phone.replace(/^0/, '');
    }

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  }

  async function deleteOrder(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;

    const res = await fetch('/api/orders/' + id, { method:'DELETE' });
    const data = await res.json();

    if (!res.ok || !data.success) {
      alert('Ø®Ø·Ø£ Ø¨Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨');
      return;
    }

    window.allOrders = window.allOrders.filter(o => o.id !== id);
    applyFilterAndRender();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const res = await fetch('/api/me');
    const data = await res.json();
    if (data.isAdmin) loadOrders();

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        applyFilterAndRender();
      });
    });
  });
</script>

</body>
</html>
